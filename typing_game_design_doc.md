# タイピングゲーム 詳細設計書

## 1. システム構成

### 1.1 アプリケーション構造
```
タイピングゲームアプリ
├── 画面レイヤー（UI）
├── 状態管理レイヤー（State Management）
├── ビジネスロジックレイヤー
└── データレイヤー
```

### 1.2 使用するFlutterパッケージ
- flutter/material.dart（標準UI）
- dart:async（タイマー機能）
- 状態管理: Provider または Riverpod（推奨）
- ローカルストレージ: shared_preferences（オプション機能用）

---

## 2. データ設計

### 2.1 単語データ構造

**WordData クラス**
- プロパティ:
  - id: int（単語の一意識別子）
  - word: String（英単語、小文字）
  - meaning: String（日本語の意味、オプション）

**単語リスト定数**
- 15〜20単語を定義
- List<WordData>型で管理

### 2.2 ゲーム状態データ構造

**GameState クラス**
- プロパティ:
  - currentQuestionIndex: int（現在の問題番号 0-4）
  - selectedWords: List<WordData>（出題される5単語）
  - currentWord: String（現在タイピング中の単語）
  - currentCharIndex: int（現在入力すべき文字位置）
  - userInput: String（ユーザーの入力文字列）
  - startTime: DateTime（ゲーム開始時刻）
  - correctChars: int（正解文字数）
  - totalChars: int（総入力文字数）
  - mistakes: int（誤入力数）
  - gameStatus: GameStatus（ゲームの状態）

**GameStatus 列挙型**
- ready（準備中）
- countdown（カウントダウン中）
- playing（プレイ中）
- finished（終了）

### 2.3 結果データ構造

**GameResult クラス**
- プロパティ:
  - totalTime: double（総タイピング時間、秒）
  - accuracy: double（正確率、パーセント）
  - wpm: double（Words Per Minute）
  - totalChars: int（総文字数）
  - correctChars: int（正解文字数）
  - mistakes: int（誤入力数）

---

## 3. 画面設計

### 3.1 スタート画面（StartScreen）

**表示要素**
- アプリタイトル: "Typing Game"
- サブタイトル: "IT Programming Terms"
- スタートボタン
- 説明テキスト: "Type 5 words as fast and accurately as you can!"

**操作**
- スタートボタンタップ → カウントダウン画面へ遷移

**状態管理**
- 特になし（静的画面）

### 3.2 カウントダウン画面（CountdownScreen）

**表示要素**
- カウントダウン数字: "3" → "2" → "1" → "Start!"
- 中央に大きく表示
- アニメーション効果（フェードイン/スケール）

**タイミング**
- 各数字: 1秒間表示
- "Start!"表示後、ゲーム画面へ自動遷移

**状態管理**
- カウントダウン値: int（3 → 2 → 1 → 0）

### 3.3 ゲーム画面（GameScreen）

**レイアウト構成**
```
┌─────────────────────────────┐
│  Question 1/5    Timer: 5.2s│  ← ヘッダー
├─────────────────────────────┤
│                             │
│       code                  │  ← 出題単語（大）
│       ████▓▓▓▓              │  ← プログレスバー
│                             │
│       入力フィールド          │
│                             │
└─────────────────────────────┘
```

**表示要素**

1. **ヘッダー部**
   - 問題番号表示: "Question X/5"
   - 経過時間表示: "Timer: XX.Xs"

2. **メインエリア**
   - 出題単語表示
     - フォントサイズ: 32px
     - 文字色分け:
       - 入力済み（正解）: 緑（#4CAF50）
       - 未入力: グレー（#9E9E9E）
   - プログレスバー（オプション）
     - 入力進捗を視覚化

3. **入力エリア**
   - テキスト入力フィールド
   - 自動フォーカス
   - 入力内容は非表示または薄く表示

**操作フロー**
1. 画面表示時、入力フィールドに自動フォーカス
2. ユーザーがキー入力
3. 1文字ごとに判定処理実行
4. 単語完了時、次の問題へ自動遷移（0.5秒後）
5. 5問完了後、結果画面へ遷移

**状態管理**
- GameState（全体の状態）
- タイマー（0.1秒ごとに更新）

### 3.4 結果画面（ResultScreen）

**表示要素**

1. **タイトル**
   - "Results"

2. **スコア表示カード**
   - 総タイピング時間: "XX.X seconds"
   - 正確率: "XX.X%"
   - タイプ速度: "XX WPM"
   - 誤入力数: "X mistakes"

3. **詳細情報（オプション）**
   - 総文字数
   - 正解文字数

4. **アクションボタン**
   - "Try Again" ボタン → スタート画面へ
   - "View Details" ボタン → 各問題の詳細表示（オプション）

**レイアウト**
- カード形式で見やすく配置
- 重要な指標を強調表示

**状態管理**
- GameResult（結果データ）

---

## 4. 処理フロー設計

### 4.1 アプリ起動フロー
```
1. アプリ起動
2. 単語データ初期化
3. スタート画面表示
```

### 4.2 ゲーム開始フロー
```
1. スタートボタンタップ
2. 単語プールから5単語をランダム選択
3. GameState初期化
4. カウントダウン画面表示
5. カウントダウン開始（3, 2, 1, Start!）
6. ゲーム開始時刻記録
7. ゲーム画面へ遷移
```

### 4.3 タイピング処理フロー
```
1. キー入力検知
2. 入力文字取得
3. 現在の正解文字と比較
   ├─ 正解の場合:
   │  ├─ correctChars + 1
   │  ├─ currentCharIndex + 1
   │  └─ 文字色を緑に変更
   └─ 不正解の場合:
      ├─ mistakes + 1
      ├─ currentCharIndex + 1（次へ進む）
      └─ 視覚フィードバック（オプション）
4. totalChars + 1
5. 単語完了チェック
   ├─ 完了の場合:
   │  ├─ 0.5秒待機
   │  ├─ currentQuestionIndex + 1
   │  ├─ 次の問題へ
   │  └─ 入力フィールドクリア
   └─ 未完了の場合:
      └─ 入力継続
6. 全問題完了チェック
   ├─ 完了の場合:
   │  ├─ 終了時刻記録
   │  ├─ 結果計算
   │  └─ 結果画面へ遷移
   └─ 未完了の場合:
      └─ 次の文字入力待ち
```

### 4.4 結果計算フロー
```
1. 総タイピング時間計算
   = 終了時刻 - 開始時刻（秒）

2. 正確率計算
   = (correctChars / totalChars) × 100

3. WPM計算
   = (全単語の総文字数 / 5) / (総タイピング時間 / 60)

4. GameResultオブジェクト生成

5. 結果画面へデータ渡し
```

---

## 5. ロジック詳細設計

### 5.1 単語選択ロジック

**関数名**: selectRandomWords()

**処理内容**:
1. 単語プール（List<WordData>）を取得
2. Randomクラスでランダムインデックス生成
3. 5回繰り返してランダムに単語を選択
4. 選択した単語リストを返す

**注意事項**:
- 重複を許可（同じ単語が複数回出題される可能性あり）

### 5.2 入力判定ロジック

**関数名**: checkInput(String inputChar)

**入力**: 
- inputChar: ユーザーが入力した文字（1文字）

**処理内容**:
1. 入力文字を小文字に変換
2. currentWord[currentCharIndex]と比較
3. 正解判定:
   - 一致 → correctChars++
   - 不一致 → mistakes++
4. totalChars++
5. currentCharIndex++
6. 単語完了判定:
   - currentCharIndex == currentWord.length
   - true → 次の問題へ
7. 全問題完了判定:
   - currentQuestionIndex == 5
   - true → ゲーム終了処理

**返り値**:
- bool: 正解ならtrue、不正解ならfalse

### 5.3 タイマー処理

**タイマー種別**: Periodic Timer

**更新間隔**: 100ms（0.1秒）

**処理内容**:
1. 現在時刻取得
2. 開始時刻との差分計算
3. UI更新（経過時間表示）

**開始タイミング**: ゲーム画面表示時

**停止タイミング**: 全問題完了時

### 5.4 スコア計算ロジック

**関数名**: calculateResult()

**処理内容**:

1. **総タイピング時間**
   - 計算式: 終了時刻 - 開始時刻
   - 単位: 秒（小数点第1位まで）

2. **正確率**
   - 計算式: (correctChars / totalChars) × 100
   - 単位: パーセント（小数点第1位まで）
   - エッジケース: totalChars == 0 の場合は0%

3. **WPM**
   - 計算式: (総文字数 / 5) / (総タイピング時間秒 / 60)
   - 単位: Words Per Minute（小数点第1位まで）
   - エッジケース: 総タイピング時間 == 0 の場合は0 WPM

4. **誤入力数**
   - そのまま使用

**返り値**:
- GameResult オブジェクト

---

## 6. 状態管理設計

### 6.1 状態管理方式
- **推奨**: Provider パターン
- **代替**: Riverpod, Bloc

### 6.2 状態クラス構成

**GameStateNotifier**
- 役割: ゲーム全体の状態管理
- 管理する状態: GameState
- 提供するメソッド:
  - startGame(): ゲーム開始
  - handleInput(String char): 入力処理
  - nextQuestion(): 次の問題へ
  - finishGame(): ゲーム終了
  - reset(): リセット

**TimerNotifier**
- 役割: タイマー管理
- 管理する状態: 経過時間（double）
- 提供するメソッド:
  - start(): タイマー開始
  - stop(): タイマー停止
  - reset(): タイマーリセット

---

## 7. エラーハンドリング設計

### 7.1 想定されるエラー

1. **単語データが空**
   - 対応: デフォルト単語リストを使用

2. **入力が予期しない文字**
   - 対応: 英字小文字以外は無視

3. **タイマーが正常に動作しない**
   - 対応: フォールバック処理（手動計算）

4. **状態の不整合**
   - 対応: 状態をリセットしてスタート画面へ

### 7.2 バリデーション

1. **入力文字のバリデーション**
   - 正規表現: ^[a-z]$
   - 不正な入力は処理をスキップ

2. **ゲーム状態のバリデーション**
   - 各状態遷移時にチェック
   - 不正な状態の場合はエラーログ出力

---

## 8. パフォーマンス設計

### 8.1 最適化ポイント

1. **UI更新の最小化**
   - 必要な部分のみ再描画
   - const コンストラクタの活用

2. **タイマーの効率化**
   - 不要な計算を避ける
   - キャッシュの活用

3. **状態更新の最適化**
   - 変更のあった部分のみ通知

### 8.2 メモリ管理

1. **タイマーの適切な破棄**
   - 画面遷移時にキャンセル

2. **リスナーの解放**
   - dispose時に確実に解放

---

## 9. テスト設計

### 9.1 単体テスト項目

1. **単語選択ロジック**
   - ランダムに5単語選択されるか
   - 単語プールが正しく読み込まれるか

2. **入力判定ロジック**
   - 正解判定が正しく動作するか
   - 不正解判定が正しく動作するか
   - カウンターが正しく増えるか

3. **スコア計算ロジック**
   - 正確率が正しく計算されるか
   - WPMが正しく計算されるか
   - エッジケースの処理

### 9.2 統合テスト項目

1. **ゲームフロー**
   - スタートから結果表示までの一連の流れ
   - 画面遷移が正しく動作するか

2. **状態管理**
   - 状態が正しく保持されるか
   - 状態遷移が正しく動作するか

### 9.3 UIテスト項目

1. **表示確認**
   - 各画面が正しく表示されるか
   - 文字色が正しく変わるか

2. **操作確認**
   - ボタンタップが正しく動作するか
   - キー入力が正しく受け付けられるか

---

## 10. 将来の拡張設計

### 10.1 拡張ポイント

1. **難易度追加**
   - データ構造に難易度フィールド追加
   - 難易度選択画面の追加

2. **ランキング機能**
   - ローカルストレージ連携
   - スコア保存・読み込み機能

3. **単語カテゴリ追加**
   - カテゴリ選択機能
   - 複数の単語リスト管理

4. **サウンド追加**
   - 効果音ファイルの管理
   - サウンド再生ロジック

### 10.2 拡張時の注意点

- 既存の状態管理構造を維持
- データ構造の後方互換性を保つ
- テストコードの追加

---

## 11. IT・プログラミング用語リスト（初級）

以下の単語から15〜20個を選定してアプリに組み込む：

- code（コード）
- data（データ）
- file（ファイル）
- loop（ループ）
- array（配列）
- bug（バグ）
- test（テスト）
- debug（デバッグ）
- input（入力）
- output（出力）
- api（API）
- app（アプリ）
- web（ウェブ）
- net（ネット）
- link（リンク）
- git（Git）
- html（HTML）
- css（CSS）
- json（JSON）
- sql（SQL）

---

## ドキュメント管理情報

- **作成日**: 2025年10月28日
- **バージョン**: 1.0
- **対象プロジェクト**: Flutter Web タイピングゲーム
- **次のステップ**: 実装フェーズへ移行